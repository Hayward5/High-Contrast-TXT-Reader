<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å°æ¯”æ™ºæ…§å‹å°èªªé–±è®€å™¨ (TTSæœ—è®€ç‰ˆ)</title>
    <style>
        :root {
            /* Windows é«˜å°æ¯”é¢¨æ ¼é…è‰² */
            --bg-color: #000000;       /* ç´”é»‘èƒŒæ™¯ */
            --text-color: #FFFF00;     /* äº®é»ƒæ–‡å­— */
            --ui-border: #00FF00;      /* äº®ç¶ é‚Šæ¡† */
            --ui-bg: #111111;          /* UI æ·±ç°èƒŒæ™¯ */
            --highlight: #00FF00;      /* å¼·èª¿è‰² */
            --alert-color: #FF0055;    /* è­¦å‘Š/åœæ­¢è‰² */
            --font-size: 24px;
            --line-height: 1.6;
            --brightness: 1;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ç¦æ­¢æ•´å€‹é é¢å‡ºç¾æ²è»¸ */
        }

        /* --- å·¥å…·åˆ— --- */
        #toolbar {
            background-color: var(--ui-bg);
            border-bottom: 2px solid var(--ui-border);
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 20;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label { 
            font-size: 14px; 
            color: #fff; 
            font-weight: bold;
        }

        /* æŒ‰éˆ•æ¨£å¼ - é«˜å°æ¯”é¢¨æ ¼ */
        button, .file-btn {
            background: #000;
            color: var(--ui-border);
            border: 2px solid var(--ui-border);
            padding: 6px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: 0.1s;
            text-transform: uppercase;
            min-width: 40px;
        }

        button:hover, .file-btn:hover {
            background: var(--ui-border);
            color: #000;
        }

        button:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            background: #000;
        }

        /* ç‰¹æ®ŠæŒ‰éˆ•ï¼šåœæ­¢æœ—è®€ */
        button.reading-active {
            border-color: var(--alert-color);
            color: var(--alert-color);
            animation: pulse 1.5s infinite;
        }
        button.reading-active:hover {
            background: var(--alert-color);
            color: #fff;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); }
        }

        input[type="file"] { display: none; }
        
        /* æ»‘æ¡¿æ¨£å¼ */
        input[type="range"] {
            width: 80px;
            accent-color: var(--ui-border);
            cursor: pointer;
        }

        /* --- é–±è®€å€åŸŸ (æ ¸å¿ƒ) --- */
        #reader-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden; /* éš±è—æº¢å‡ºï¼Œåªé¡¯ç¤ºç®—å¥½çš„é‚£ä¸€é  */
            width: 100%;
            margin: 0 auto;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
        }

        #reader-content {
            padding: 40px 60px; /* é–±è®€æ–‡å­—é‚Šè· */
            font-size: var(--font-size);
            line-height: var(--line-height);
            opacity: var(--brightness);
            white-space: pre-wrap; /* ä¿ç•™åŸå§‹æ›è¡Œ */
            text-align: justify;
            height: 100%; /* å……æ»¿å®¹å™¨ */
            overflow: hidden; 
            word-break: break-all;
        }

        /* --- æœå°‹é¢æ¿ --- */
        #search-panel {
            position: absolute;
            top: 0;
            right: -350px; /* é è¨­éš±è— */
            width: 350px;
            height: 100%;
            background: var(--ui-bg);
            border-left: 2px solid var(--ui-border);
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 30;
            box-shadow: -10px 0 20px rgba(0,0,0,0.9);
        }

        #search-panel.open { right: 0; }

        .search-header {
            padding: 15px;
            border-bottom: 2px solid var(--ui-border);
            display: flex;
            gap: 5px;
            background: #000;
        }

        #searchInput {
            flex: 1;
            background: #000;
            border: 1px solid var(--ui-border);
            color: #fff;
            padding: 8px;
            font-size: 14px;
            outline: none;
        }
        
        #searchInput:focus {
            background: #222;
        }

        #search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #000;
        }

        /* æœå°‹çµæœæ²è»¸æ¨£å¼ */
        #search-results::-webkit-scrollbar {
            width: 8px;
        }
        #search-results::-webkit-scrollbar-track {
            background: #000;
        }
        #search-results::-webkit-scrollbar-thumb {
            background: var(--ui-border);
        }

        .result-item {
            padding: 12px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 14px;
            color: #aaa;
            line-height: 1.4;
        }
        .result-item:hover { 
            background: var(--ui-border); 
            color: #000; 
        }
        .result-item:hover .result-highlight {
            color: #000; /* åç™½æ™‚é«˜äº®å­—è®Šé»‘ */
            text-decoration: underline;
        }
        .result-highlight { 
            color: var(--ui-border); 
            font-weight: bold; 
            font-size: 1.1em;
        }

        /* --- ç‹€æ…‹åˆ— --- */
        #statusbar {
            background-color: var(--ui-bg);
            border-top: 1px solid #333;
            padding: 5px 15px;
            font-size: 13px;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            font-family: monospace;
        }

        /* é€²åº¦è¼¸å…¥æ¡†æ¨£å¼ */
        .progress-control {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        #progress-input {
            background: transparent;
            color: var(--text-color);
            border: 1px solid #444;
            border-radius: 4px;
            width: 60px;
            text-align: right;
            font-family: monospace;
            font-size: 13px;
            padding: 2px 4px;
            outline: none;
            transition: border-color 0.2s;
        }

        #progress-input:focus {
            border-color: var(--ui-border);
            background: #222;
        }
        
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- éŸ¿æ‡‰å¼èª¿æ•´ --- */
        @media (max-width: 768px) {
            #reader-content { padding: 20px 20px; }
            #toolbar { gap: 8px; padding: 8px; justify-content: center; }
            .control-group { gap: 5px; }
            label span { display: none; } /* æ‰‹æ©Ÿéš±è—æ¨™ç±¤æ–‡å­— */
            #search-panel { width: 100%; right: -100%; border-left: none; }
            button, .file-btn { padding: 4px 8px; font-size: 12px; }
            #char-info { display: none; }
        }
    </style>
</head>
<body>

    <!-- å·¥å…·åˆ— -->
    <div id="toolbar">
        <div class="control-group">
            <label class="file-btn">
                é–‹å•Ÿ
                <input type="file" id="fileInput" accept=".txt">
            </label>
            <span id="fileNameDisplay" style="font-size: 12px; color: var(--ui-border); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">æœªé¸æ“‡</span>
        </div>

        <div class="control-group">
            <button onclick="saveManualBookmark()" title="å„²å­˜æ›¸ç±¤">å­˜</button>
            <button onclick="loadManualBookmark()" title="è®€å–æ›¸ç±¤">è®€</button>
        </div>
        
        <div class="control-group">
            <!-- TTS æŒ‰éˆ• -->
            <button id="ttsBtn" onclick="toggleTTS()" title="æœ—è®€/åœæ­¢ (è‡ªå‹•ç¿»é )">æœ—è®€</button>
        </div>

        <div class="control-group">
            <label title="å­—é«”å¤§å°">A<input type="range" id="fontSizeRange" min="14" max="50" value="24" oninput="updateStyle()"></label>
            <label title="äº®åº¦èª¿æ•´">â˜€<input type="range" id="brightnessRange" min="0.2" max="1" step="0.1" value="1" oninput="updateStyle()"></label>
        </div>

        <div class="control-group">
            <button onclick="toggleSearch()" title="æœå°‹">ğŸ”</button>
            <button id="prevBtn" onclick="manualTurnPage(-1)">â—€</button>
            <button id="nextBtn" onclick="manualTurnPage(1)">â–¶</button>
        </div>
    </div>

    <!-- é–±è®€å€ -->
    <div id="reader-wrapper">
        <div id="reader-content">
            <div style="margin-top: 10vh; text-align: center; color: #888;">
                <h2 style="color: var(--ui-border);">é«˜å°æ¯” TXT é–±è®€å™¨</h2>
                <p>è«‹é»é¸å·¦ä¸Šè§’ã€Œé–‹å•Ÿã€è¼‰å…¥å°èªª</p>
                <hr style="border: 1px solid #333; width: 50%;">
                <ul style="text-align: left; display: inline-block;">
                    <li><b>æœ—è®€åŠŸèƒ½</b>ï¼šé»æ“Šä¸Šæ–¹ã€Œæœ—è®€ã€éµï¼Œè®€å®Œè‡ªå‹•ç¿»é </li>
                    <li><b>è‡ªé©æ‡‰æ’ç‰ˆ</b>ï¼šç„¡é ˆä¸Šä¸‹æ²å‹•</li>
                    <li><b>é€²åº¦è·³è½‰</b>ï¼šä¿®æ”¹å·¦ä¸‹è§’æ•¸å­—å¯è·³è½‰</li>
                    <li><b>è‡ªå‹•è¨˜æ†¶</b>ï¼šé—œé–‰å¾Œå†é–‹è‡ªå‹•å›åˆ°ä¸Šæ¬¡é€²åº¦</li>
                </ul>
            </div>
        </div>

        <!-- æœå°‹å´é‚Šæ¬„ -->
        <div id="search-panel">
            <div class="search-header">
                <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­—..." onkeydown="if(event.key==='Enter') performSearch()">
                <button onclick="performSearch()">æœå°‹</button>
                <button onclick="toggleSearch()">âœ•</button>
            </div>
            <div id="search-results">
                <div style="text-align:center; padding:20px; color:#666;">è«‹è¼¸å…¥é—œéµå­—ä¸¦æŒ‰ä¸‹æœå°‹</div>
            </div>
        </div>
    </div>

    <!-- ç‹€æ…‹åˆ— -->
    <div id="statusbar">
        <div class="progress-control" title="é»æ“Šè¼¸å…¥æ•¸å­—å¯è·³è½‰">
            <input type="number" id="progress-input" value="0.00" min="0" max="100" step="0.01">
            <span>%</span>
        </div>
        <span id="char-info">å­—å…ƒ: 0 / 0</span>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let fullText = "";
        let currentIndex = 0;
        let currentFileName = "";
        let pageHistory = [];
        
        // --- TTS ç›¸é—œè®Šæ•¸ ---
        let isTTSActive = false;
        let ttsSynth = window.speechSynthesis;
        let ttsVoice = null;
        let ttsUtterance = null;
        
        // --- DOM å…ƒç´  ---
        const readerContent = document.getElementById('reader-content');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const progressInput = document.getElementById('progress-input');
        const charInfo = document.getElementById('char-info');
        const searchPanel = document.getElementById('search-panel');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('search-results');
        const ttsBtn = document.getElementById('ttsBtn');

        // --- 1. åˆå§‹åŒ–èˆ‡æª”æ¡ˆè®€å– ---
        
        // å˜—è©¦è¼‰å…¥èªéŸ³ (Chrome éœ€è¦ onvoiceschanged)
        function initVoices() {
            const voices = ttsSynth.getVoices();
            // å„ªå…ˆæ‰¾å°ç£ç¹é«”ï¼Œå…¶æ¬¡ä¸­æ–‡ï¼Œæœ€å¾Œéš¨ä¾¿ä¸€å€‹
            ttsVoice = voices.find(v => v.lang === 'zh-TW') || 
                       voices.find(v => v.lang.startsWith('zh')) || 
                       voices[0];
        }
        initVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            stopTTS(); // æ›æª”æ¡ˆæ™‚åœæ­¢æœ—è®€

            currentFileName = file.name;
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.title = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                fullText = e.target.result;
                // çµ±ä¸€æ›è¡Œç¬¦è™Ÿ
                fullText = fullText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\t/g, '    ');
                
                loadAutoProgress();
                renderCurrentPage();
            };
            reader.readAsText(file);
        });

        // --- 2. TTS æœ—è®€é‚è¼¯ ---

        function toggleTTS() {
            if (!fullText) {
                alert("è«‹å…ˆé–‹å•Ÿæª”æ¡ˆ");
                return;
            }

            if (isTTSActive) {
                stopTTS();
            } else {
                startTTS();
            }
        }

        function startTTS() {
            if (isTTSActive) return; // é¿å…é‡è¤‡å•Ÿå‹•
            
            isTTSActive = true;
            ttsBtn.textContent = "åœæ­¢";
            ttsBtn.classList.add("reading-active");
            
            speakCurrentContent();
        }

        function stopTTS() {
            isTTSActive = false;
            ttsSynth.cancel(); // ç«‹å³åœæ­¢ç™¼è²
            ttsBtn.textContent = "æœ—è®€";
            ttsBtn.classList.remove("reading-active");
        }

        function speakCurrentContent() {
            if (!isTTSActive) return;

            // ç¢ºä¿å…ˆåœæ­¢ä¹‹å‰çš„
            ttsSynth.cancel();

            const textToRead = readerContent.textContent;
            if (!textToRead.trim()) return;

            ttsUtterance = new SpeechSynthesisUtterance(textToRead);
            if (ttsVoice) ttsUtterance.voice = ttsVoice;
            ttsUtterance.rate = 1; // èªé€Ÿ
            ttsUtterance.pitch = 1; // éŸ³èª¿

            // ç•¶æœ¬é è®€å®Œæ™‚çš„äº‹ä»¶
            ttsUtterance.onend = function() {
                // åªæœ‰åœ¨ã€Œä»ç„¶æ˜¯å•Ÿç”¨ç‹€æ…‹ã€æ™‚æ‰ç¿»é 
                // å¦‚æœæ˜¯ä½¿ç”¨è€…æŒ‰äº†åœæ­¢ï¼ŒisTTSActive æœƒæ˜¯ falseï¼Œé€™æ®µå°±ä¸æœƒåŸ·è¡Œ
                if (isTTSActive) {
                    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä¸‹ä¸€é 
                    const charsOnPage = parseInt(readerContent.dataset.charsOnPage || 0);
                    if (currentIndex + charsOnPage < fullText.length) {
                        // 1. è‡ªå‹•ç¿»é  (ä½¿ç”¨ true åƒæ•¸ä»£è¡¨é€™æ˜¯è‡ªå‹•ç¿»é ï¼Œä¸è¦åœæ­¢ TTS)
                        turnPage(1, true);
                        
                        // 2. ç¨å¾®å»¶é²ä¸€é»é»å†è®€ä¸‹ä¸€é ï¼Œæ¯”è¼ƒè‡ªç„¶
                        setTimeout(() => {
                            if (isTTSActive) speakCurrentContent();
                        }, 500);
                    } else {
                        stopTTS(); // è®€å®Œäº†
                    }
                }
            };

            ttsUtterance.onerror = function(e) {
                console.error("TTS Error:", e);
                stopTTS();
            };

            ttsSynth.speak(ttsUtterance);
        }

        // --- 3. æ ¸å¿ƒç¿»é èˆ‡æ’ç‰ˆ ---

        function renderCurrentPage() {
            if (!fullText) return;

            readerContent.innerHTML = "";
            
            const tempSpan = document.createElement('span');
            readerContent.appendChild(tempSpan);
            
            const maxCharsToCheck = 4000;
            const remainingTextLen = fullText.length - currentIndex;
            const limit = Math.min(remainingTextLen, maxCharsToCheck);
            
            let low = 0;
            let high = limit;
            let fitIndex = 0;
            const maxHeight = readerContent.clientHeight;

            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                tempSpan.textContent = fullText.substr(currentIndex, mid);
                
                if (readerContent.scrollHeight > maxHeight) {
                    high = mid - 1;
                } else {
                    fitIndex = mid;
                    low = mid + 1;
                }
            }

            // æ™ºæ…§æ–·å¥
            if (currentIndex + fitIndex < fullText.length) {
                const buffer = Math.min(fitIndex, 60);
                const rawSub = fullText.substr(currentIndex, fitIndex);
                let lastBreak = rawSub.lastIndexOf('\n');
                
                if (lastBreak === -1 || lastBreak < fitIndex - buffer) {
                     const lastPunctuation = Math.max(
                        rawSub.lastIndexOf('ã€‚'), rawSub.lastIndexOf('ï¼'), 
                        rawSub.lastIndexOf('ï¼Ÿ'), rawSub.lastIndexOf('â€'), rawSub.lastIndexOf('ã€')
                    );
                    if (lastPunctuation > fitIndex - buffer) lastBreak = lastPunctuation;
                }
                if (lastBreak > fitIndex - buffer) fitIndex = lastBreak + 1;
            }

            if (fitIndex === 0 && remainingTextLen > 0) fitIndex = 1;

            const pageText = fullText.substr(currentIndex, fitIndex);
            readerContent.textContent = pageText;
            
            updateStatus(fitIndex);
            saveAutoProgress();
            
            readerContent.dataset.charsOnPage = fitIndex;
        }

        function updateStatus(charsOnPage) {
            const total = fullText.length;
            let percent = 0;
            if (total > 0) percent = ((currentIndex + charsOnPage) / total * 100).toFixed(2);
            progressInput.value = percent;
            charInfo.textContent = `å­—å…ƒ: ${currentIndex} / ${total}`;
            
            document.getElementById('prevBtn').disabled = (currentIndex === 0);
            document.getElementById('nextBtn').disabled = (currentIndex + charsOnPage >= total);
        }

        // æ‰‹å‹•ç¿»é  (æœƒåœæ­¢ TTS)
        function manualTurnPage(direction) {
            stopTTS(); // æ‰‹å‹•æ“ä½œå¼·åˆ¶åœæ­¢æœ—è®€
            turnPage(direction, false);
        }

        // æ ¸å¿ƒç¿»é å‡½å¼
        // isAutoTurn: å¦‚æœæ˜¯ TTS è‡ªå‹•å‘¼å«çš„ï¼Œå‚³å…¥ trueï¼Œé€™æ¨£å°±ä¸æœƒè¢«è¦–ç‚ºæ‰‹å‹•æ“ä½œ
        function turnPage(direction, isAutoTurn = false) {
            if (!fullText) return;

            if (direction === 1) {
                const charsOnPage = parseInt(readerContent.dataset.charsOnPage || 0);
                if (currentIndex + charsOnPage >= fullText.length) return;

                pageHistory.push(currentIndex);
                currentIndex += charsOnPage;
                renderCurrentPage();

            } else if (direction === -1) {
                if (pageHistory.length > 0) {
                    currentIndex = pageHistory.pop();
                    renderCurrentPage();
                } else if (currentIndex > 0) {
                    const approximateChars = Math.floor((readerContent.clientWidth * readerContent.clientHeight) / (parseInt(getComputedStyle(readerContent).fontSize) ** 2));
                    let targetIndex = Math.max(0, currentIndex - Math.floor(approximateChars * 0.8));
                    currentIndex = targetIndex;
                    pageHistory = []; 
                    renderCurrentPage();
                }
            }
        }

        // --- 4. é€²åº¦æ§åˆ¶èˆ‡è¨˜æ†¶ ---
        
        progressInput.addEventListener('change', function() {
            stopTTS(); // è·³è½‰é€²åº¦ä¹Ÿç®—æ‰‹å‹•æ“ä½œ
            if (!fullText) { this.value = "0.00"; return; }
            
            let val = parseFloat(this.value);
            if (isNaN(val)) val = 0;
            if (val < 0) val = 0; if (val > 100) val = 100;
            
            const newIndex = Math.floor((val / 100) * fullText.length);
            currentIndex = newIndex;
            if (currentIndex >= fullText.length) currentIndex = Math.max(0, fullText.length - 100);
            
            pageHistory = [];
            renderCurrentPage();
            this.blur(); 
        });

        progressInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') this.blur();
        });

        function saveAutoProgress() {
            if (currentFileName) localStorage.setItem('txt_auto_' + currentFileName, currentIndex);
        }

        function loadAutoProgress() {
            if (currentFileName) {
                const savedIdx = localStorage.getItem('txt_auto_' + currentFileName);
                if (savedIdx !== null) {
                    const idx = parseInt(savedIdx);
                    if (idx < fullText.length) { currentIndex = idx; pageHistory = []; }
                }
            }
        }

        function saveManualBookmark() {
            if (!currentFileName) { alert("è«‹å…ˆé–‹å•Ÿæª”æ¡ˆ"); return; }
            localStorage.setItem('txt_manual_' + currentFileName, currentIndex);
            alert(`âœ… æ›¸ç±¤å·²å„²å­˜ï¼é€²åº¦: ${progressInput.value}%`);
        }

        function loadManualBookmark() {
            stopTTS(); // è®€å–æ›¸ç±¤åœæ­¢æœ—è®€
            if (!currentFileName) { alert("è«‹å…ˆé–‹å•Ÿæª”æ¡ˆ"); return; }
            const savedIdx = localStorage.getItem('txt_manual_' + currentFileName);
            if (savedIdx !== null) {
                const idx = parseInt(savedIdx);
                if (confirm(`æ‰¾åˆ°æ›¸ç±¤ (ä½ç½®: ${idx})ï¼Œè·³è½‰ï¼Ÿ`)) {
                    currentIndex = idx;
                    pageHistory = [];
                    renderCurrentPage();
                }
            } else {
                alert("ç„¡æ›¸ç±¤");
            }
        }

        // --- 5. æœå°‹åŠŸèƒ½ ---
        function toggleSearch() {
            searchPanel.classList.toggle('open');
            if (searchPanel.classList.contains('open')) {
                searchInput.focus();
                searchInput.select();
            }
        }

        function performSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword || !fullText) return;

            searchResults.innerHTML = '<div style="padding:10px; color:#888;">æœå°‹ä¸­...</div>';
            
            setTimeout(() => {
                const results = [];
                let pos = fullText.indexOf(keyword);
                let count = 0;
                
                while (pos !== -1 && count < 100) {
                    const start = Math.max(0, pos - 15);
                    const end = Math.min(fullText.length, pos + keyword.length + 20);
                    let snippet = fullText.substring(start, end);
                    const highlightedSnippet = snippet.split(keyword).join(`<span class="result-highlight">${keyword}</span>`);
                    results.push({ index: pos, snippet: highlightedSnippet });
                    pos = fullText.indexOf(keyword, pos + 1);
                    count++;
                }
                displayResults(results, keyword);
            }, 50);
        }

        function displayResults(results, keyword) {
            searchResults.innerHTML = '';
            if (results.length === 0) {
                searchResults.innerHTML = `<div style="padding:10px;">æ‰¾ä¸åˆ° "${keyword}"</div>`;
                return;
            }

            const infoDiv = document.createElement('div');
            infoDiv.style.padding = "10px";
            infoDiv.style.color = "#888";
            infoDiv.style.fontSize = "12px";
            infoDiv.textContent = `å‰ ${results.length} ç­†çµæœï¼š`;
            searchResults.appendChild(infoDiv);

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `...${item.snippet}... <br><span style="color:#555; font-size:12px;">ä½ç½®: ${item.index}</span>`;
                div.onclick = () => {
                    stopTTS(); // æœå°‹è·³è½‰åœæ­¢æœ—è®€
                    currentIndex = item.index;
                    pageHistory = [];
                    renderCurrentPage();
                    if (window.innerWidth < 768) toggleSearch();
                };
                searchResults.appendChild(div);
            });
        }

        // --- 6. æ¨£å¼èˆ‡äº‹ä»¶ç›£è½ ---
        function updateStyle() {
            const fontSize = document.getElementById('fontSizeRange').value;
            const brightness = document.getElementById('brightnessRange').value;
            document.documentElement.style.setProperty('--font-size', fontSize + 'px');
            document.documentElement.style.setProperty('--brightness', brightness);
            renderCurrentPage();
        }

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                renderCurrentPage();
            }, 100);
        });

        document.addEventListener('keydown', function(e) {
            const active = document.activeElement;
            if ((searchPanel.classList.contains('open') && active === searchInput) || active === progressInput) return;

            if (e.key === 'ArrowLeft') {
                manualTurnPage(-1);
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault(); 
                manualTurnPage(1);
            }
        });

        updateStyle();

    </script>
</body>
</html>
